#Download the zip file and unzip
if(!file.exists("data")){dir.create("data")}
fileUrl <- "http://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip"
download.file(fileUrl, destfile = "./data/Project.zip")
unzip ("./data/Project.zip")


#Read activity labels and features

Act_Label <- read.table("./UCI HAR Dataset/activity_labels.txt")[,2]

feature <- read.table("./UCI HAR Dataset/features.txt")[,2]

get_feature <- grepl("mean|std", feature)

Xtest <- read.table("./UCI HAR Dataset/test/X_test.txt")
Ytest <- read.table("./UCI HAR Dataset/test/Y_test.txt")
Subtest <- read.table("./UCI HAR Dataset/test/subject_test.txt")

names(Xtest) = feature

Xtest = Xtest[, get_feature]

Ytest[,2] = Act_Label[Ytest[,1]]
names(Ytest) = c("Activity_ID","Activity_Label")
names(Subtest) = "subject"


Testdata <- cbind(as.data.table(Subtest),Ytest,Xtest)

Xtrain <- read.table("./UCI HAR Dataset/train/X_train.txt")
Ytrain <- read.table("./UCI HAR Dataset/train/Y_train.txt")

Subtrain <- read.table("./UCI HAR Dataset/train/subject_train.txt")

names(Xtrain) = feature

Xtrain = Xtrain[, get_feature]

Ytrain[,2] = Act_Label[Ytrain[,1]]
names(Ytrain) = c("Activity_ID","Activity_Label")
names(Subtrain) = "subject"

TrainData <- cbind(as.data.table(Subtrain), Ytrain, Xtrain)

Merge = rbind(Testdata, TrainData, fill = TRUE)

IdLabel <- c("subject","Activity_ID","Activity_Label")
DataLabel <- setdiff(colnames(Merge), IdLabel)
Melt = melt(Merge, id = IdLabel, measure.vars = DataLabel)

TidyData = dcast(Melt, subject + Activity_Label ~ variable, mean)

write.table(TidyData, file = "./TidyData.txt", row.names=FALSE)

